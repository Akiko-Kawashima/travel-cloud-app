<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>旅行売上・粗利・未回収 管理（クラウド版 / Supabase）</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#121521; --line:#262b42; --text:#eef0f6;
      --muted:#9aa3b2; --ok:#3ddc97; --bad:#ff6b6b; --warn:#ffcc66;
      --shadow: 0 16px 60px rgba(0,0,0,.45);
    }
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 700px at 20% 0%, rgba(61,220,151,.18), transparent 55%),
                radial-gradient(900px 600px at 80% 10%, rgba(255,204,102,.12), transparent 55%),
                var(--bg);
      color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      letter-spacing:.2px;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 40px}
    h1{font-size:28px; margin:4px 0 18px}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px}
    .pill{display:inline-flex; gap:10px; align-items:center}
    .tag{
      padding:8px 12px; border:1px solid var(--line); border-radius:999px;
      background: rgba(18,21,33,.55); color:var(--muted); font-size:13px;
    }
    .tag.ok{border-color: rgba(61,220,151,.35); color: var(--ok)}
    .tag.bad{border-color: rgba(255,107,107,.45); color: var(--bad)}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(18,21,33,.92), rgba(18,21,33,.68));
      border:1px solid var(--line); border-radius:18px; padding:18px;
      box-shadow: var(--shadow); backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px; font-size:18px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .field{margin:10px 0}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input{
      width:100%; box-sizing:border-box; padding:12px 12px;
      border-radius:12px; border:1px solid var(--line);
      background: rgba(11,12,16,.65); color:var(--text);
      outline:none;
    }
    input:focus{border-color: rgba(61,220,151,.45)}
    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    button{
      cursor:pointer; padding:11px 14px; border-radius:12px;
      border:1px solid var(--line); background: rgba(11,12,16,.25);
      color:var(--text); font-weight:600;
    }
    button.primary{background: rgba(61,220,151,.14); border-color: rgba(61,220,151,.35)}
    button.danger{background: rgba(255,107,107,.10); border-color: rgba(255,107,107,.35)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .statusLine{
      padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background: rgba(11,12,16,.30); margin-top:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12.5px; color:var(--muted);
      white-space:pre-wrap; word-break:break-word;
    }
    .statusLine.ok{border-color: rgba(61,220,151,.35); color: var(--ok)}
    .statusLine.bad{border-color: rgba(255,107,107,.35); color: var(--bad)}
    .toast{
      position: fixed; right: 18px; bottom: 18px;
      background: rgba(18,21,33,.92); border:1px solid var(--line);
      color: var(--text); padding: 12px 14px; border-radius: 12px;
      box-shadow: var(--shadow); max-width: 420px; z-index: 9999;
      opacity:0; transform: translateY(8px); transition: .18s ease;
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .hint{color:var(--muted); font-size:12px; line-height:1.7; margin-top:10px}
    .hint b{color:var(--text)}
    .mini{font-size:12px;color:var(--muted); margin-top:8px}
  </style>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>旅行売上・粗利・未回収 管理（クラウド版 / Supabase）</h1>
      <div class="pill">
        <span id="whoTag" class="tag">未ログイン</span>
        <span id="roleTag" class="tag">role: -</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ログイン</h2>

        <div class="row">
          <div class="field">
            <label>メール</label>
            <input id="email" type="email" placeholder="staff@example.com" />
          </div>
          <div class="field">
            <label>パスワード</label>
            <input id="password" type="password" placeholder="********" />
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnSignIn">ログイン</button>
          <button id="btnSignUp">新規登録</button>
          <button class="danger" id="btnLogout" disabled>ログアウト</button>
        </div>

        <div class="hint">
          ※ スタッフは「新規登録」→（<b>メール確認</b>がONならメールのConfirm）→「ログイン」でOK。<br/>
          ※ 管理者付与は、管理者が Supabase の <b>members.role</b> を staff→admin に変更した時だけ。
        </div>
      </div>

      <div class="card">
        <h2>状態</h2>
        <div class="mini">この枠は「接続確認」と「原因切り分け」用。うまくいかない時の情報がここに出るようにしてあります。</div>

        <div id="sbLine" class="statusLine">Supabase: ...</div>
        <div id="userLine" class="statusLine">user: -</div>
        <div id="msgLine" class="statusLine">message: -</div>

        <div class="hint" style="margin-top:12px">
          よくある原因：<br/>
          ・Supabase の Auth 設定で <b>Email confirmations</b> がONなのに、確認前にログインしようとしている<br/>
          ・Supabase の <b>Site URL / Redirect URLs</b> が localhost のまま（Confirm が localhost に飛ぶ）<br/>
          ・パスワード違い / メール確認が未完了 / 別プロジェクトのURL・KEYを入れている
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ==============================
    // 0) SET YOUR KEYS HERE
    // ==============================
    const SUPABASE_URL = "https://yuhjerjsfcpwyzeogvmk.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";

    // ★超重要：変数名は "supabase" にしない（window.supabase と衝突/二重宣言が起きやすい）
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==============================
    // small helpers
    // ==============================
    const $ = (id) => document.getElementById(id);

    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove('show'), 3600);
    };

    const setLine = (el, text, kind) => {
      el.textContent = text;
      el.classList.remove('ok','bad');
      if(kind) el.classList.add(kind);
    };

    const setTags = (userEmail, role) => {
      const whoTag = $('whoTag');
      const roleTag = $('roleTag');

      if(userEmail){
        whoTag.textContent = userEmail;
        whoTag.className = 'tag ok';
      }else{
        whoTag.textContent = '未ログイン';
        whoTag.className = 'tag';
      }

      roleTag.textContent = 'role: ' + (role || '-');
      roleTag.className = 'tag';
    };

    let sessionUser = null;
    let myRole = null;

    // ==============================
    // 1) Handle email confirmation redirect (PKCE)
    //    Confirm のリンクが「このサイト」に戻ってきた時にセッション確立する
    // ==============================
    async function handleAuthRedirectIfAny(){
      try{
        const url = new URL(window.location.href);
        const code = url.searchParams.get('code'); // PKCE flow
        if(code){
          setLine($('msgLine'), 'message: exchanging code...', null);
          const { data, error } = await sb.auth.exchangeCodeForSession(code);
          if(error){
            setLine($('msgLine'), 'message: ' + error.message, 'bad');
            return;
          }
          // URL をきれいにする
          url.searchParams.delete('code');
          window.history.replaceState({}, document.title, url.toString());

          toast('メール確認が完了しました。ログイン状態を更新します。');
        }
      }catch(e){
        // ignore
      }
    }

    // ==============================
    // 2) Connection check
    // ==============================
    async function checkSupabase(){
      try{
        // 軽いAPI呼び出し（認証不要）
        const { data, error } = await sb.from('members').select('id').limit(1);
        if(error){
          setLine($('sbLine'), 'Supabase: NG (' + error.message + ')', 'bad');
        }else{
          setLine($('sbLine'), 'Supabase: OK', 'ok');
        }
      }catch(e){
        setLine($('sbLine'), 'Supabase: NG (Failed to fetch / network)', 'bad');
      }
    }

    // ==============================
    // 3) Role fetch
    // ==============================
    async function refreshRole(){
      myRole = 'staff';
      if(!sessionUser) return;

      const { data, error } = await sb
        .from('members')
        .select('role,email')
        .eq('user_id', sessionUser.id)
        .maybeSingle();

      if(error){
        // 権限/ポリシーで取れない場合など
        myRole = 'staff';
        return;
      }
      if(data && data.role) myRole = data.role;
    }

    // ==============================
    // 4) UI state sync
    // ==============================
    async function syncSessionToUI(){
      const { data } = await sb.auth.getSession();
      sessionUser = data.session?.user || null;

      if(sessionUser){
        await refreshRole();
        $('btnLogout').disabled = false;
      }else{
        myRole = null;
        $('btnLogout').disabled = true;
      }

      setTags(sessionUser?.email || null, myRole);
      setLine($('userLine'), 'user: ' + (sessionUser?.email || '-'), null);
    }

    // ==============================
    // 5) Auth actions
    // ==============================
    async function signUp(){
      const email = $('email').value.trim();
      const password = $('password').value;

      if(!email || !password){
        toast('メールとパスワードを入れてね');
        return;
      }

      setLine($('msgLine'), 'message: signing up...', null);

      // ★超重要：Confirm が localhost に飛ぶのを防ぐ（メールのリンク先を今のドメインにする）
      const emailRedirectTo = window.location.origin;

      const { data, error } = await sb.auth.signUp({
        email,
        password,
        options: { emailRedirectTo }
      });

      if(error){
        setLine($('msgLine'), 'message: ' + error.message, 'bad');
        toast('登録エラー: ' + error.message);
        return;
      }

      setLine($('msgLine'), 'message: signUp OK. Check email confirmation if enabled.', 'ok');

      // Email confirmations がONなら、ここではログイン状態にならず「確認メール待ち」になる
      toast('登録OK。メール確認が必要なら、届いたメールのConfirmを押してからログインしてね。');
      await syncSessionToUI();
    }

    async function signIn(){
      const email = $('email').value.trim();
      const password = $('password').value;

      if(!email || !password){
        toast('メールとパスワードを入れてね');
        return;
      }

      setLine($('msgLine'), 'message: signing in...', null);

      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      if(error){
        setLine($('msgLine'), 'message: ' + error.message, 'bad');
        toast('ログインエラー: ' + error.message);
        return;
      }

      sessionUser = data.user;
      setLine($('msgLine'), 'message: login OK', 'ok');
      toast('ログインしました');
      await syncSessionToUI();
    }

    async function logout(){
      setLine($('msgLine'), 'message: signing out...', null);
      const { error } = await sb.auth.signOut();
      if(error){
        setLine($('msgLine'), 'message: ' + error.message, 'bad');
        toast('ログアウトエラー: ' + error.message);
        return;
      }
      setLine($('msgLine'), 'message: signed out', 'ok');
      toast('ログアウトしました');
      await syncSessionToUI();
    }

    // ==============================
    // boot
    // ==============================
    $('btnSignUp').addEventListener('click', signUp);
    $('btnSignIn').addEventListener('click', signIn);
    $('btnLogout').addEventListener('click', logout);

    // セッション変化を追従
    sb.auth.onAuthStateChange(async () => {
      await syncSessionToUI();
    });

    (async function init(){
      await handleAuthRedirectIfAny();
      await checkSupabase();
      await syncSessionToUI();
      setLine($('msgLine'), 'message: ready', null);
    })();
  </script>
</body>
</html>
